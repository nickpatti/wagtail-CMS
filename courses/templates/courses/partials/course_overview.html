{% load staticfiles discover_uni_tags %}
{% load humanize %}

<div class="course-detail__lead">
    <div class="">
        <ul class="course-detail__nav">
            <li class="course-detail__nav-control">
                <form method="post" id="back_to_search" {% if page.is_english %} action="/course-finder/results/" {% else %} action="/cy/course-finder/results/" {% endif %}>
                    <span id='course-detail__nav-control-back' style="visibility: hidden;">
                        <img class="course-detail__nav-control-icon" src="{% static 'assets/left-arrow.svg' %}" alt="">
                        {% get_translation key='back_to_results' language=page.get_language %}
                    </span>
                </form>
            </li>
        </ul>

        <h1 class="course-detail__course-name">
            {{course.display_title}}
        </h1>

            {% if page.is_english %}
                <a class="course-detail__institution-name" href="/institution-details/{{course.institution.pub_ukprn}}/">
                    {% autoescape off %}{{course.institution.pub_ukprn_name | safe}}{% endautoescape %}
                </a>
            {% else %}
                <a class="course-detail__institution-name" href="/cy/institution-details/{{course.institution.pub_ukprn}}/">
                    {% autoescape off %}{{course.institution.pub_ukprn_name | safe}}{% endautoescape %}
                </a>
            {% endif %}

            <div class="d-flex flex-wrap row mt-2">
                <div class="col-md-8 col-sm-12">
                    <p class="course-detail__institution-locations">
                        {% if course.number_of_locations == 1 %}
                            {{ course.number_of_locations }} {% get_translation key='location' language=page.get_language %}: {{ course.locations_list }}
                        {% else %}
                            {{ course.number_of_locations }} {% get_translation key='locations' language=page.get_language %}: {{ course.locations_list }}
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-4 col-sm-12 float-md-right mb-2">
                    <button class="course-detail__compare-btn">
                        <img class="add" src="{% static 'images/white-bookmark.svg' %}" alt="">
                        <img class="remove" src="{% static 'images/white-bookmark.svg' %}" alt="">
                         {% get_translation key='bookmark_course' language=page.get_language %}
                    </button>
                </div>
            </div>
    </div>

    <div class="">
        <div class="course-detail__overview-lead mt-1 pb-0">
            <h4>Course details</h4>
            <hr/>
        </div>
        <div class="course-detail__course-overview my-2">
            <div class="d-flex justify-content-between flex-wrap col-12 px-0">
                <div class="course-detail__overview-item overview-block my-2 mx-3 align-self-stretch">
                    <p class="course-detail__overview-item-heading">{% get_translation key='study_mode' language=page.get_language %}</p>
                    <p class="course-detail__overview-item-value">
                        {% if course.mode.label == 'Both' %}
                            {% get_translation key='full_time' language=page.get_language %}
                            {% get_translation key='part_time' language=page.get_language %}
                        {% else %}
                            {% get_translation key=course.mode.label language=page.get_language %}
                        {% endif %}
                    </p>
                </div>
            
                {% if course.mode.label != 'Part-time' %}
                    <div class="course-detail__overview-item overview-block my-2 mx-3 align-self-stretch">
                        <p class="course-detail__overview-item-heading">{% get_translation key='length' language=page.get_language %}</p>
                        <p class="course-detail__overview-item-value">{{ course.length.label | slice:1 }} {% get_translation key='year_course' language=page.get_language %}</p>
                    </div>
                {% endif %}

                <div class="course-detail__overview-item overview-block my-2 mx-3 align-self-stretch">
                    <p class="course-detail__overview-item-heading">{% get_translation key='distance_learning' language=page.get_language %}</p>
                    <p class="course-detail__overview-item-value">{{ course.distance_learning.display_label }}</p>
                </div>

                <div class="course-detail__overview-item overview-block my-2 mx-3 align-self-stretch">
                    <p class="course-detail__overview-item-heading">{% get_translation key='placement_year' language=page.get_language %}</p>
                    <p class="course-detail__overview-item-value">{% get_translation key=course.sandwich_year.label language=page.get_language %}</p>
                </div>

                <div class="course-detail__overview-item overview-block my-2 mx-3 align-self-stretch">
                    <p class="course-detail__overview-item-heading">{% get_translation key='year_abroad' language=page.get_language %}</p>
                    <p class="course-detail__overview-item-value">{% get_translation key=course.year_abroad.label language=page.get_language %}</p>
                </div>

                <div class="course-detail__overview-item overview-block my-2 mx-3 align-self-stretch">
                    <p class="course-detail__overview-item-heading">{% get_translation key='foundation_year' language=page.get_language %}</p>
                    <p class="course-detail__overview-item-value">{% get_translation key=course.foundation_year.label language=page.get_language %}</p>
                </div>
            </div>
        </div>
    </div>

    {% if not course.has_multiple_subject_names %}
        <div class="course-detail__headline_statistics d-flex flex-row align-items-stretch my-4 text-center text-md-left mx-auto px-0">
            <div class="course-detail__headline_stat flex-fill align-self-stretch mr-2 mr-xs-1 px-3 px-xs-2 py-4">
                <h3 class="d-none d-lg-block">{% get_translation key='student_satisfaction_course_overview_1' language=page.get_language %}</h3>
                <h2>{{ course.satisfaction_stats.0.question_27.agree_or_strongly_agree }}%</h2>
                <p>{% get_translation key='student_satisfaction_course_overview_2' language=page.get_language %}</p>
            </div>

            {% if course.summary_med_sal_value != "no_data" %}
                <div class="course-detail__headline_stat flex-fill align-self-stretch ml-2 ml-xs-1 mr-2 mr-xs-1 px-3 px-xs-2 py-4">
                    <h3 class="d-none d-lg-block">{% get_translation key='average_earnings_course_overview_1' language=page.get_language %}</h3>
                    <h2 id="average_earnings_sm" class="d-lg-none">{{ course.summary_med_sal_value|intcomma }}</h2>
                    <h2 id="average_earnings_lg" class="d-none  d-lg-block">£{{ course.salaries_inst.0.med|intcomma }}</h2>
                    <p>{% get_translation key=course.summary_med_sal_text_trans_key language=page.get_language %}</p>
                </div>
            {% endif %}

            <div class="course-detail__headline_stat flex-fill align-self-stretch ml-2 ml-xs-2 px-3 px-xs-2 py-4">
                <h3 class="d-none d-lg-block">{% get_translation key='employment_course_overview_1' language=page.get_language %}</h3>
                <h2>{{ course.employment_stats.0.in_work_and_study }}%</h2>
                <p>{% get_translation key='employment_course_overview_2' language=page.get_language %}</p>
            </div>
        </div>

    {% elif course.has_multiple_subject_names %}
        <div class="course-detail__headline_statistics d-flex flex-row align-items-stretch my-4 text-center text-md-left mx-auto px-0 row-cols-3">
            <div class="col">
                <h3 class="d-none d-lg-block">{% get_translation key='student_satisfaction_course_overview_1' language=page.get_language %}</h3>
                <div class="course-detail__headline_stat flex-fill align-self-stretch mr-2 mr-xs-1px-3 px-xs-2 py-4 container">
                    <div class="row">
                        <div class="col">
                            {% for satisfaction_stat in course.satisfaction_stats %}
                            <h4 style="display: inline;">For all {{satisfaction_stat.display_subject_name}} courses</h4> <h2 style="display: inline;">{{ satisfaction_stat.question_27.agree_or_strongly_agree }}%</h2></br>
                            {% endfor %}
                        </div>
                        <div class="col-2">
                            <p>{% get_translation key='student_satisfaction_course_overview_2' language=page.get_language %}</p>
                        </div>
                    </div>
                </div>
            </div>

            {% if course.summary_med_sal_value != "no_data" %}
            <div class="col">
                <h3 class="d-none d-lg-block">{% get_translation key='average_earnings_course_overview_1' language=page.get_language %}</h3>
                <div class="course-detail__headline_stat flex-fill align-self-stretch mr-2 mr-xs-1 px-3 px-xs-2 py-4 container">
                    <div class="row">
                        <div class="col">
                            {% for go_salary in course.go_salaries_inst %}
                            <h4 style="display: inline;">For all {{go_salary.display_subject_name}} courses</h4> <h2 style="display: inline;">£{{ go_salary.med|intcomma }}</h2></br>
                            {% endfor %}
                        </div>
                        <div class="col-2">
                            <p>{% get_translation key=course.summary_med_sal_text_trans_key language=page.get_language %}</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="col">
                <h3 class="d-none d-lg-block">{% get_translation key='employment_course_overview_1' language=page.get_language %}</h3>
                <div class="course-detail__headline_stat flex-fill align-self-stretch mr-2 mr-xs-1 px-3 px-xs-2 py-4 container">
                    <div class="row">
                        <div class="col">
                            {% for employment_stat in course.employment_stats %}
                            <h4 style="display: inline;">For all {{employment_stat.display_subject_name}} courses</h4> <h2 style="display: inline;">{{ employment_stat.in_work_and_study }}%</h2></br>
                            {% endfor %}
                        </div>
                        <div class="col-2">
                            <p>{% get_translation key='employment_course_overview_2' language=page.get_language %}</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    {% endif %}

</div>

<script>
    function kFormatter(num) {
        return Math.abs(num) > 999 ? Math.sign(num)*((Math.abs(num)/1000).toFixed(1)) + 'k' : Math.sign(num)*Math.abs(num)
    }
    function reformatField(){   
        var earnings = $('#average_earnings_sm').text();
            earnings = earnings.replace('£','');
            earnings = parseFloat(earnings.replace(/,/g, ''));
            var reformatted = kFormatter(earnings);
            $('#average_earnings_sm').text("£" + reformatted);
    }
    
    $( document ).ready(function() {
        reformatField();
    });
</script>